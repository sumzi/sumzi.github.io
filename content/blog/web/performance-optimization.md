---
title: 성능 최적화
date: "2022-11-06"
category: "web"
---

## 성능 최적화에 필요한 이론

### 브라우저의 로딩 과정

브라우저는 웹 페이지에 필요한 리소스를 내려받고 해석한 다음 여러 계산 과정을 거쳐 콘텐츠를 화면에 보여준다. 이를 브라우저 로딩 과정이라고 하며 다운로드, 파싱, 스타일, 레이아웃, 페인트, 합성으로 나뉜다.

- 파싱
  - 파싱이 일어나면 HTML을 해석해 DOM을 생성한 후, 각 DOM 객체를 트리 데이터 구조로 연결해 부모-자식 관계를 만든다. `<body>, <p>, <div>` 등 각 태그가 DOM 트리의 노드의 생성되고 자식 노드를 참조한다.
  - style.css등 외부 스타일시트 파일이나 내부 스타일시트가 포함되어 있을 경우, CSS를 해석해 CSSOM 트리를 구성한다.
- 스타일
  - 파싱 단계에서 생성된 DOM, CSSOM 트리를 가지고 스타일을 매칭 시켜주는 과정을 거쳐 렌더 트리를 구성한다.
- 레이아웃
  - 노드의 정확한 위치와 크기를 계산한다. 루트부터 노드를 순회하면서 계산하고, 레이아웃 결과로 각 노드의 정확한 위치와 크기를 픽셀값으로 렌더 트리에 반영한다.
- 페인트
  - 계산된 값을 이용해 렌더 트리의 각 노드를 화면상의 실제 픽셀로 변환한다. 이때 위치와 관계없는 CSS 속성을 적용한다.
- 합성, 렌더
  - 페인트 단계에서 생성된 레이어를 합성하여 스크린을 업데이트 한다. 합성과 렌더 단계가 끝나면 화면에서 웹 페이지를 볼 수 있다.

### 블록 리소스와 주요 렌더링 경로

브라우저 로딩 초기 단계에서 HTML 파싱이 일어날 때 CSS, JS로 인해 파싱이 중단될 수 있다. 이렇게 파싱이 중단되는 상황을 HTML 파싱이 블록되었다라고 표현하며, 블록 상태의 원인이 되는 리소스를 블록 리소스(Block resource)라고 부른다.

블록 리소스는 브라우저 로딩 단계 중 페인트 과정을 지연시키므로, 블록 리소스가 HTML 파싱을 막는 상황이 발생하지 않도록 해야한다.

### 레아아웃과 리페인트

브라우저 로딩 과정 중 스타일 이후의 과정 (스타일→레이아웃→페인트→합성)을 렌더링이라고 하는데, 이 렌더링 과정은 상황에 따라 반복하여 발생할 수 있다. 스타일 단계에서 구성되는 렌더 트리는 자바스크립트에 의해 DOM트리, CSSOM트리가 변경될 때 다시 재구성된다. DOM이 추가, 삭제되거나 요소에 기하적인 영향(넓이, 높이, 위치)을 주는 CSS 속성값을 변경하는 경우 렌더 트리가 다시 재구성된다.

- 레이아웃부터 이후 과정을 다시 수행하며 이것을 **레이아웃**(또는 리플로우)이라고 한다.
- 레이아웃은 요소에 기하적인 영향을 주는 CSS 속성값을 변경할 때 발생하였는데, 반대로 영향을 주지 않는 CSS 속성값을 변경하면 레이아웃 과정을 건너 뛴다. 페인트부터 수행하며 이를 **리페인트**라고 한다.

### 브라우저 기준의 성능 측정

전통적인 성능 측정 방식은 브라우저에서 발생하는 이벤트를 사용하는 것이었다. 웹 페이지가 로딩될 때 `DOMContentLoaded`, `load` 이벤트가 발생하며, 각 이벤트가 발생하는 시점으로 성능을 측정하게 된다. 두 이벤트 발생 시점이 빠를수록, 발생 구간의 폭이 좁을수록 성능이 좋다고 말한다.

- DOMContentLoaded 이벤트
  - HTML과 CSS 파싱이 끝나는 시점
  - 렌더 트리를 구성할 준비가 된 상황
- load 이벤트
  - HTML 상에 필요한 모든 리소스가 로드된 시점
- 내비게이션 타이밍 API 사용
  - 이벤트 발생 시점을 알 수 있다.
- 크롬 개발자 도구 사용
  - 크롬 개발자 도구는 브라우저에서 이벤트 발생 시점을 확인할 수 있도록 UI를 제공하고 다양한 측정 방법을 제공한다.
- 사용자 기준의 성능 측정
  - 사용자 기준의 성능 측정은 사용자에게 콘텐츠를 보여주는 여러 시점을 기반으로 한다. 의미 있는 콘텐츠가 처음 보이는 시점이 빠를수록 성능이 좋다고 판단하며, 이 시점을 앞당길 수 있도록 최적화해야한다.
  - 구글에서 지정한 성능 시점
    - FP(First Paint) : 흰 화면에서 화면에 무언가가 처음으로 그려지기 시작하는 순간
    - FCP(First Contentful Paint) : 텍스트나 이미지가 출력되기 시작하는 순간
    - FMP(First Meaningful Paint) : 사용자에게 의미있는 콘텐츠가 그려지기 시작하는 첫 순간
    - TTI(Time to Interactive) : 자바스크립트의 초기 실행이 완료되어서 사용자가 직접 행동을 취할 수 있는 순간

### 성능 측정 도구

크롬 브라우저에서는 개발자 도구를 제공하며, 이 개발자 도구를 사용해 성능을 측정하고 확인할 수 있다.

- Performance 패널
  - 웹 페이지 로딩 단계를 차트 형태로 살펴볼 수 있다.
  - 웹 페이지가 로드되는 과정을 레코딩하고 단계마다 걸리는 시간을 확인할 수 있다.
  - 로딩 과정에서 최적화가 필요한 부분을 찾을 때 사용한다.
- Network 패널
  - 웹 페이지가 로딩되는 동안 요청된 리소스의 상태를 차트 형태로 확인할 수 있으며, 리소스 최적화 상태를 비교할 때 사용한다.
  - Performance 패널과 같이 레코딩하고, 레코딩이 끝나면 overview와 Request Table에 리소스 요청 정보가 나타난다. 이때 리소스 목록은 시간순으로 정렬된다.
  - 차트 부분을 선택하면 각 리소스의 서버 요청 대기 시간을 자세히 볼 수 있다.
- LightHouse
  - 사용자 기준의 성능 측정 지표를 확인할 수 있다. 화면은 크게 성능 측정 전후로 나뉘는데, 측정 전 화면에서는 어떤 환경에서 성능을 측정할지 선택할 수 있다.
  - 느린 네트워크 환경의 시뮬레이션이 필요하다면 Throttling 영역을 설정한다.
  - Opportunities: 최적화 가능한 리소스 목록을 보여주는 영역
  - Diagnostics: 리소스 최적화 외에 성능을 개선할 수 있는 부분을 진단하고 해결 방안을 목록으로 보여주는 영역

## 웹 페이지 로딩 최적화

### 블록 리소스 최적화

브라우저 로딩 과정에서 파싱 중 블록 리소스가 발생할 수 있으며, CSS와 JS가 블록 리소스에 해당한다. 최적화의 첫번째 단계는 이 블록 리소스를 최적화하는 것이다.

- CSS 최적화
  - DOM 트리는 파싱 중에 태그를 발견할 때마다 순차적으로 구성할 수 있지만, CSSOM은 CSS를 모두 해석해야 구성할 수 있다. 즉, CSSOM 트리가 구성되지 않으면 렌더 트리를 만들지 못하고 렌더링이 차단된다.
  - CSS는 렌더링 차단 리소스라고 하며, 렌더링이 차단되지 않도록 CSS는 항상 HTML문서 최상단`<head>`아래 에 배치한다.
  - 외부 스타일시트를 가져올 때 사용하는 `@import` 사용은 피한다. 브라우저는 스타일시트를 병렬로 다운로드 할 수 없기 때문에 로드시간이 늘어 날 수 있다. 내부 스타일시트를 사용한다.
- 자바스크립트 최적화
  - 자바스크립트는 DOM트리와 CSSOM트리를 동적으로 변경할 수 있기 떄문에 HTML 파싱을 차단하는 블록 리소스다.
  - `<script>`태그를 만나면 스크립트가 실행되며 그 이전까지 생성된 DOM에만 접근할 수 있다. 그리고 스크립트 실행이 완료될 때까지 DOM 트리 생성은 중단된다. 자바스크립트도 렌더링 차단 리소스라고하며, HTML문서 최하단 `</body>`직전에 배치한다.

### 리소스 요청 수 줄이기

- 이미지 스프라이트
  - 여러개 이미지를 하나로 만들고 CSS의 background-position 속성을 사용해 부분 이미지 사용하는 방법이다.
- CSS, JS 번들하기
  - 모듈기반의 개발 방식이 등장하기 이전까지 분리된 여러개의 리소스 파일을 가져와 사용했었다. 이 경우에는 웹팩과 같은 번들러를 사용하여 CSS, 자바스크립트 파일 요청을 줄일 수 있다.
  - 번들러는 여러개의 모듈 파일을 하나로 묶어서 1개파일로 생성해주는데 이것을 번들 파일이라고 한다.
- 작은 이미지를 HTML, CSS로 대체
  - 웹 페이지에서 사용하는 아이콘 이미지 개수가 적은 경우, 다운로드한 이미지를 사용하는 대신 Data URI로 처리할 수 있으며, HTML,CSS에서 외부 경로로 이미지를 가져오던 부분을 Base64로 변환된 URI로 대체한다.
  - 이렇게하면 외부 이미지를 사용하기 위해 발생하는 요청 횟수를 줄일 수 있다.

### 리소스 용량 줄이기

- 중복 코드 제거하기
  - 자바스크립트 코드 중 자주 사용되는 코드는 utils파일로 정리해 사용한다. 용량이 늘어나는 문제를 막을 수 있다.
- HTML 마크업 최적화
  - 태그의 중첩을 최소화하여 단순하게 구성한다. 또한 공백, 주석 등을 제거하여 사용한다.
- 간결한 CSS 선택자 사용
  - 스타일을 적용할 때 간결한 CSS 선택자를 사용해 최적화한다.
  - ID 대신 클래스 선택자를 사용하면 중복되는 스타일을 묶어서 처리할 수 있다.
- 압축하여 사용하기
  - HTML, JS, CSS 모두 압축해서 사용할 수 있으며, 불필요한 주석이나 공백 등을 제거한 다음 난독화하여 사용한다.
  - 웹팩 플러그인과 같은 도구로 처리할 수 있다.

## 참고

- [https://ui.toast.com/fe-guide/ko_PERFORMANCE#성능-측정-도구](https://ui.toast.com/fe-guide/ko_PERFORMANCE#%EC%84%B1%EB%8A%A5-%EC%B8%A1%EC%A0%95-%EB%8F%84%EA%B5%AC)
- [https://d2.naver.com/helloworld/59361](https://d2.naver.com/helloworld/59361)
